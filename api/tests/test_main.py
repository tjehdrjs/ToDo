# ------------------------------------------------------------------
# íŒŒì¼ëª…: test_setup.py (ì˜ˆì‹œ)
# ëª©ì : FastAPI ì•±ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.
# - ì‹¤ì œ DBë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ë©”ëª¨ë¦¬ì—ì„œë§Œ ë™ì‘í•˜ëŠ” ì„ì‹œ DBë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
# - FastAPI ì•±ì´ ì´ í…ŒìŠ¤íŠ¸ìš© DBë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë°”ê¿”ì¤ë‹ˆë‹¤.
# ------------------------------------------------------------------

# í…ŒìŠ¤íŠ¸ ë„êµ¬: pytestëŠ” íŒŒì´ì¬ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬
import pytest

# ë¹„ë™ê¸° í…ŒìŠ¤ì¸  ì§€ì›: pytestì—ì„œ async í•¨ìˆ˜ë„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•˜ê²Œ í•´ì¤ë‹ˆë‹¤
import pytest_asyncio

# httpx: ì½”ë“œë¡œ HTTP ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆëŠ” í´ë¼ì´ì–¸íŠ¸ (FastAPIì™€ ì˜ í˜¸í™˜ë¨)
from httpx import AsyncClient, ASGITransport

# SQLAlchemy ë¹„ë™ê¸° ì „ìš© ëª¨ë“ˆ
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker

# í”„ë¡œì íŠ¸ ë‚´ë¶€ ì½”ë“œ ë¶ˆëŸ¬ì˜¤ê¸° (DB ì„¸ì…˜ í•¨ìˆ˜, DB ëª¨ë¸, FastAPI ì•±)
from api.db import get_db, Base
from api.main import app

# íƒ€ì… íŒíŠ¸ë¥¼ ìœ„í•œ ëª¨ë“ˆ
from typing import AsyncGenerator

# HTTP ìƒíƒœ ì½”ë“œë¥¼ ì§ê´€ì ì¸ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë¶ˆëŸ¬ì˜´
# ì˜ˆ: status.HTTP_200_OK, status.HTTP_404_NOT_FOUND ë“±
import starlette.status as status


# ------------------------------------------------------------------
# ASYNC_DB_URL: í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©í•  ì„ì‹œ SQLite ë°ì´í„°ë² ì´ìŠ¤ ì£¼ì†Œ
# - ":memory:"ëŠ” ì‹¤ì œ íŒŒì¼ì„ ë§Œë“¤ì§€ ì•Šê³ , ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥í•¨
# - í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ DB ë‚´ìš©ì€ ëª¨ë‘ ì‚¬ë¼ì§
# ------------------------------------------------------------------
ASYNC_DB_URL = "sqlite+aiosqlite:///:memory:"


# ------------------------------------------------------------------
# async_client: í…ŒìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©í•  ë¹„ë™ê¸° HTTP í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“œëŠ” í•¨ìˆ˜
# - ì´ í•¨ìˆ˜ëŠ” fixtureë¡œ ë“±ë¡ë˜ì–´ ì—¬ëŸ¬ í…ŒìŠ¤íŠ¸ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥
# - yieldë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ AsyncGeneratorë¡œ íƒ€ì… ì§€ì •í•´ì•¼ í•¨
# ------------------------------------------------------------------
@pytest_asyncio.fixture
async def async_client() -> AsyncGenerator[AsyncClient, None]:
    # ------------------------------------------------------------------
    # 1. í…ŒìŠ¤íŠ¸ìš© ë¹„ë™ê¸° DB ì—”ì§„ë  ì„¸ì…˜ ìƒì„±ê¸° ì„¤ì •
    # - ì‹¤ì œ ì„œë¹„ìŠ¤ìš© DBì™€ëŠ” ì™„ì „íˆ ë¶„ë¦¬ë¨
    # ------------------------------------------------------------------
    async_engine = create_async_engine(ASYNC_DB_URL, echo=True)
    async_session = sessionmaker(
        autocommit=False,  # ëª…ì‹œì ìœ¼ë¡œ commit í•´ì•¼ ì €ì¥ë¨
        autoflush=False,  # flush íƒ€ì´ë°ë„ ì§ì ‘ ì œì–´
        bind=async_engine,  # ìœ„ì—ì„œ ë§Œë“  ë¹„ë™ê¸° DB ì—”ì§„ ì‚¬ìš©
        class_=AsyncSession,  # ì„¸ì…˜ì€ ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©
    )

    # ------------------------------------------------------------------
    # 2. í…ŒìŠ¤íŠ¸ìš© DB ì´ˆê¸°í™” (í…Œì´ë¸” ì „ì²´ ì‚­ì œ í›„ ì¬ìƒì„±)
    # ------------------------------------------------------------------
    async with async_engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)  # ê¸°ì¡´ í…Œì´ë¸” ì œê±°
        await conn.run_sync(Base.metadata.create_all)  # í•„ìš”í•œ í…Œì´ë¸” ìƒì„±

    # ------------------------------------------------------------------
    # 3. get_db() í•¨ìˆ˜ë¥¼ í…ŒìŠ¤íŠ¸ìš© DBì™€ ì—°ê²°ë˜ë„ë¡ override
    # - ì‹¤ì œ ì•±ì—ì„œ ì‚¬ìš©í•˜ëŠ” DB ëŒ€ì‹  í…ŒìŠ¤íŠ¸ìš© DBì˜¤ ì‘ë™í•˜ê²Œ ë§Œë“¦
    # ------------------------------------------------------------------
    async def get_test_db():
        async with async_session() as session:
            yield session
            # yieldëŠ” sessionì„ ì™¸ë¶€ë¡œ ì ê¹ ë„˜ê¸°ì†Œ, ëë‚˜ë©´ ì •ë¦¬ ì‘ì—… ì‹¤í–‰

    app.dependency_overrides[get_db] = get_test_db

    # ------------------------------------------------------------------
    # 4. í…ŒìŠ¤íŠ¸ìš© HTTP í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    # - FastAPI ì„œë²„ë¥¼ ì‹¤ì œë¡œ ë„ìš°ì§€ ì•Šì•„ë„ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆìŒ
    # - base_urlì€ ë‚´ë¶€ì ìœ¼ë¡œë§Œ ì‚¬ìš©ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì£¼ì†Œ
    # ------------------------------------------------------------------
    transport = ASGITransport(app=app, raise_app_exceptions=True)
    async with AsyncClient(transport=transport, base_url="http://test") as client:
        yield client
        # í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ì—ì„œ ì´ clientë¥¼ ì‚¬ìš©í•˜ë©´, ì‹¤ì œ ì„œë²„ ì—†ì–´ë„ ì•±ì— ìš”ì²­ ê°€ëŠ¥


# ------------------------------------------------------------------
# [í…ŒìŠ¤íŠ¸ í•¨ìˆ˜] í•  ì¼ ìƒì„± ë° ëª©ë¡ ì¡°íšŒ í…ŒìŠ¤íŠ¸
# - Post /taskë¡œ í•  ì¼ì„ í•˜ë‚˜ ì¶”ê°€í•˜ê³ 
# - Get /taskë¡œ ì „ì²´ ëª©ë¡ì„ ì¡°íšŒí•´ ê²°ê³¼ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤
# ------------------------------------------------------------------
@pytest.mark.asyncio
async def test_create_and_read(async_client):
    # ------------------------------------------------------------------
    # 1. ìƒˆë¡œìš´ í•  ì¼ì„ ì¶”ê°€ (POST ìš”ì²­)
    # - titleì´ "í…ŒìŠ¤íŠ¸ ì‘ì—…"ì¸ í•  ì¼ì„ ì„œë²„ì— ì¶”ê°€ ìš”ì²­
    # ------------------------------------------------------------------
    response = await async_client.post("/tasks", json={"title": "í…ŒìŠ¤íŠ¸ ì‘ì—…"})
    assert response.status_code == status.HTTP_200_OK  # ì‘ë‹µì´ 200 OKì¸ì§€ í™•ì¸

    response_obj = response.json()
    assert response_obj["title"] == "í…ŒìŠ¤íŠ¸ ì‘ì—…"
    # ì‘ë‹µ JSONì— titleì´ ì˜ ë“¤ì–´ê°”ëŠ”ì§€ í™•ì¸

    # ------------------------------------------------------------------
    # 2. ì „ì²´ í•  ì¼ ëª©ë¡ ì¡°íšŒ (GET ìš”ì²­)
    # - ë°©ê¸ˆ ì¶”ê°€í•œ í•  ì¼ì´ ëª©ë¡ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    # ------------------------------------------------------------------
    response = await async_client.get("/tasks")
    assert response.status_code == status.HTTP_200_OK  # 200 OK í™•ì¸

    response_obj = response.json()
    assert len(response_obj) == 1  # í•  ì¼ ê°œìˆ˜ê°€ 1ê°œì¸ì§€ í™•ì¸
    assert response_obj[0]["title"] == "í…ŒìŠ¤íŠ¸ ì‘ì—…"  # ê·¸ í•  ì¼ì˜ ì œëª©ì´ ì •í™•í•œì§€ í™•ì¸
    assert response_obj[0]["done"] is False  # ì™„ë£Œ ì—¬ë¶€ê°€ Falseì¸ì§€ í™•ì¸ (ê¸°ë³¸ê°’)


@pytest.mark.asyncio
async def test_done_flag(async_client):
    # ------------------------------------------------------------------
    # [1] ìƒˆë¡œìš´ í•  ì¼ì„ ì¶”ê°€ (POST ìš”ì²­)
    # - titleì´ "í…ŒìŠ¤íŠ¸ ì‘ì—…2"ì¸ í•  ì¼ì„ ì„œë²„ì— ì¶”ê°€ ìš”ì²­
    # ------------------------------------------------------------------
    response = await async_client.post("/tasks", json={"title": "í…ŒìŠ¤íŠ¸ ì‘ì—…2"})
    assert response.status_code == status.HTTP_200_OK  # ìš”ì²­ì´ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸
    response_obj = response.json()
    assert response_obj["title"] == "í…ŒìŠ¤íŠ¸ ì‘ì—…2"

    # ------------------------------------------------------------------
    # [2] í•  ì¼ì„ ì™„ë£Œ ì²˜ë¦¬ (PUT ìš”ì²­)
    # - ì´ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” PUT /tasks ë¼ëŠ” ì£¼ì†Œì— ìš”ì²­ì„ ë³´ëƒ„
    # - ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ê°€ì¥ ë§ˆì§€ë§‰ì— ì¶”ê°€ëœ ì‘ì—…ì„ ì™„ë£Œ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹í•  ìˆ˜ ìˆìŒ
    # - ì¦‰, ìš°ë¦¬ê°€ ë°©ê¸ˆ ì¶”ê°€í•œ "í…ŒìŠ¤ì¸  ì‘ì—…2"ê°€ ì™„ë£Œ ì²˜ë¦¬ë¨
    # ------------------------------------------------------------------
    response = await async_client.put("/tasks/1/done")
    assert response.status_code == status.HTTP_200_OK
    # ì™„ë£Œ ì²˜ë¦¬ ìš”ì²­ì´ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸

    # ------------------------------------------------------------------
    # [3] ì´ë¯¸ ì™„ë£Œëœ í•  ì¼ì„ ë‹¤ì‹œ ì™„ë£Œ ì²˜ë¦¬ ì‹œë„ (PUT ìš”ì²­)
    # - /tasks/1/done ì£¼ì†Œë¡œ ìš”ì²­ì„ ë³´ë‚´ì–´ id=lì¸ ì‘ì—…ì„ ì™„ë£Œ ì²˜ë¦¬í•˜ë ¤ê³  ì‹œë„í•¨
    # - í•˜ì§€ë§Œ ì´ë¯¸ ì™„ë£Œëœ ì‘ì—…ì´ë¯€ë¡œ ì„œë²„ê°€ 400 Bad Requestë¥¼ ë°˜í™˜í•´ì•¼ í•¨
    # ------------------------------------------------------------------
    response = await async_client.put("/tasks/1/done")
    assert response.status_code == status.HTTP_400_BAD_REQUEST
    # ì¤‘ë³µ ì™„ë£Œ ìš”ì²­ - ì˜ëª»ëœ ìš”ì²­ ì²˜ë¦¬ í™•ì¸

    # ------------------------------------------------------------------
    # [4] ì™„ë£Œ ì²˜ë¦¬ëœ ì‘ì—…ì„ ì™„ë£Œ í•´ì œ (DELETE ìš”ì²­)
    # - /tasks/1/done ì£¼ì†Œë¡œ ìš”ì²­ì„ ë³´ë‚´ë©´ ì™„ë£Œ ìƒëŒ€ê°€ í•´ì œë¨ (Falseë¡œ ë³€ê²½ë¨)
    # ------------------------------------------------------------------
    response = await async_client.delete("/tasks/1/done")
    assert response.status_code == status.HTTP_200_OK
    # ì •ìƒì ìœ¼ë¡œ ì™„ë£Œ í•´ì œë˜ì—ˆëŠ”ì§€ í™•ì¸

    # ------------------------------------------------------------------
    # [5] ì´ë¯¸ ì™„ë£Œ í•´ì œëœ ì‘ì—…ì„ ë‹¤ì‹œ í•´ì œí•˜ë ¤ê³  ì‹œë„
    # - ë” ì´ìƒ ì™„ë£Œ ìƒíƒœê°€ ì•„ë‹ˆë¯€ë¡œ ì„œë²„ëŠ” í•´ë‹¹ ì‘ì—…ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  íŒë‹¨
    # - ë”°ë¼ì„œ 400 Not Found ì‘ë‹µì„ ë³´ë‚´ëŠ” ê²ƒì´ ì˜¬ë°”ë¦„
    # ------------------------------------------------------------------
    response = await async_client.delete("/tasks/1/done")
    assert response.status_code == status.HTTP_404_NOT_FOUND
    # ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìƒíƒœë¥¼ ë‹¤ì‹œ ìš”ì²­ - ì‹¤íŒ¨ ì‘ë‹µ í™•ì¸


# ------------------------------------------------------------------
# ğŸ“í…ŒìŠ¤íŠ¸ ëª©ì : ë§ˆê°ì¼(due_date)ì˜ ìœ íš¨ì„± ê²€ì‚¬
# ------------------------------------------------------------------
# ì´ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ëŠ” ì‚¬ìš©ìê°€ í•  ì¼ì„ ë“±ë¡í•  ë–„ ì…ë ¥í•˜ëŠ” `due_date` ê°’ì´
# ìœ íš¨í•˜ì§€ ì•ŠëŠ” ë‚ ì§œì´ê±°ë‚˜ ì˜¬ë°”ë¥¸ í˜•ì‹ì´ ì•„ë‹ ê²½ìš° ì„œë²„ê°€ ì–´ë–»ê²Œ ë°˜ì‘í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
#
# [ê²€ì‚¬ í•­ëª©]
# (1) ì˜¬ë°”ë¥¸ ë‚ ì§œ ì…ë ¥ ì‹œ ì •ìƒ ì²˜ë¦¬ (200 OK)
# (2) ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë‚ ì§œ (ì˜ˆ: 12ì›” 32ì¼) - ì˜¤ë¥˜ë°˜í™˜ (422)
# (3) ì˜ëª»ëœ êµ¬ë¶„ì ì‚¬ìš© (ì˜ˆ: 2004/12/01) - ì˜¤ë¥˜ë°˜í™˜ (422)
# (4) êµ¬ë¶„ì ì—†ì´ ìˆ«ìë§Œ ë‚˜ì—´ (ì˜ˆ: 20241201) - ì˜¤ë¥˜ë°˜í™˜ (422)
#
# ì´ ê²€ì‚¬ë¥¼ í†µí•´ FastAPI + Pydanticì´ ë‚ ì§œ í˜•ì‹ì„ ì–´ë–»ê²Œ ê²€ì‚¬í•˜ëŠ”ì§€ ì´í•´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
# ------------------------------------------------------------------
@pytest.mark.asyncio
async def test_due_date(async_client):
    # ------------------------------------------------------------------
    # [1] í…ŒìŠ¤íŠ¸í•  ì…ë ¥ê°’ ë¦¬ìŠ¤íŠ¸
    # ------------------------------------------------------------------
    # - ê° í•­ëª©ì€ ì‚¬ìš©ìê°€ ì „ì†¡í•  due_date ê°’ì…ë‹ˆë‹¤.
    # - ë‹¤ì–‘í•œ í˜•ì‹ê³¼ ì˜¤ë¥˜ ìœ í˜•ì„ í¬í•¨í•˜ì—¬ í…ŒìŠ¤íŠ¸ ë²”ìœ„ë¥¼ ë„“í™ë‹ˆë‹¤.
    # ------------------------------------------------------------------
    input_list = [
        "2024-12-01",  # [OK] ì˜¬ë°”ë¥¸ ë‚ ì§œ
        "2024-12-32",  # [X] ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë‚ ì§œ
        "2024/12/01",  # [X] êµ¬ë¶„ì°¨ê°€ ì˜ëª»ëœ ë‚ ì§œ
        "20241201",  # [X] êµ¬ë¶„ì ì—†ì´ ë­‰ì¹œ ë‚ ì§œ
    ]
    # ------------------------------------------------------------------
    # [2] ê¸°ëŒ€ë˜ëŠ” ì‘ë‹µ ì½”ë“œ ë¦¬ìŠ¤íŠ¸
    # ------------------------------------------------------------------
    # - ê° ì…ë ¥ê°’ì— ëŒ€í•´ ì˜ˆìƒë˜ëŠ” ì„œë²„ì˜ ì‘ë‹µ ìƒíƒœ ì½”ë“œë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.
    # - ìˆœì„œëŠ” input_listì™€ ë°˜ë“œì‹œ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
    # ------------------------------------------------------------------
    expectation_list = [
        status.HTTP_200_OK,
        status.HTTP_422_UNPROCESSABLE_ENTITY,
        status.HTTP_422_UNPROCESSABLE_ENTITY,
        status.HTTP_422_UNPROCESSABLE_ENTITY,
    ]

    # ------------------------------------------------------------------
    # [3] ë°˜ë³µë¬¸ì„ í†µí•´ ëª¨ë“  ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
    # ------------------------------------------------------------------
    # - zip()ì„ ì‚¬ìš©í•´ inputê³¼ ê¸°ëŒ€ê°’ì„ í•¨ê»˜ ê°€ì ¸ì˜µë‹ˆë‹¤.
    # - ê° ì¼€ì´ìŠ¤ì— ëŒ€í•´ POST ìš”ì²­ì„ ë³´ë‚´ê³  ìƒíƒœ ì½”ë“œê°€ ì˜ˆìƒê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    # ------------------------------------------------------------------
    for input_param, expectation in zip(input_list, expectation_list):
        response = await async_client.post(
            "/tasks",
            json={
                "title": "í…ŒìŠ¤íŠ¸ ì‘ì—…",
                "due_date": input_param,  # í˜„ì¬ í…ŒìŠ¤íŠ¸í•  ì…ë ¥ê°’
            },
        )
        # ê²°ê³¼ ê²ì¦: ì‘ë‹µ ìƒíƒœ ì½”ë“œê°€ ê¸°ëŒ€ê°’ê³¼ ì¼ì¹˜í•´ì•¼ í†µê³¼
        assert response.status_code == expectation
